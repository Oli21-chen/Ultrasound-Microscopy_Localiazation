import os
os.environ['TF_CPP_MIN_LOG_LEVEL'] = '3'
os.environ['CUDA_VISIBLE_DEVICES']='0'
import tensorflow as tf
config = tf.compat.v1.ConfigProto(gpu_options = 
                          tf.compat.v1.GPUOptions(per_process_gpu_memory_fraction=0.3))
#config.gpu_options.allow_growth = True
session = tf.compat.v1.Session(config=config)
tf.compat.v1.keras.backend.set_session(session)
import re
#from tensorflow import keras
from tensorflow.keras import layers
from tensorflow.keras import backend as K
# from keras import optimizers
from tensorflow.keras import losses
from tensorflow.keras.callbacks import Callback
from tensorflow.keras.callbacks import ReduceLROnPlateau
from tensorflow.keras.callbacks import ModelCheckpoint
from tensorflow.keras.preprocessing.image import ImageDataGenerator

import matplotlib.pyplot as plt
import numpy as np
from sklearn.model_selection import train_test_split
from skimage import io
from numpy import newaxis

#Conv block 1
inputs=tf.keras.Input(shape=(128, 128, 1))
x=layers.Conv2D(16, 3, strides=1, padding='same',activation=None, name="Conv_1")(inputs)
x=layers.BatchNormalization()(x)
x= layers.LeakyReLU(alpha=0.3)(x)
x= layers.Conv2D(16, 3, strides=1,padding='same', activation=None, name="Conv_2")(x)
x= layers.BatchNormalization()(x)
x= layers.LeakyReLU(alpha=0.3)(x)
x= layers.MaxPool2D(pool_size=(2, 2))(x)
res1=x
 #Conv block 2
x=layers.Conv2D(32, 3, strides=1,padding='same', activation=None, name="Conv_3")(x)
x=layers.BatchNormalization()(x)
x= layers.LeakyReLU(alpha=0.3)(x)
x= layers.Conv2D(32, 3, strides=1,padding='same', activation=None, name="Conv_4")(x)
x= layers.BatchNormalization()(x)
x= layers.LeakyReLU(alpha=0.3)(x)
x= layers.MaxPool2D(pool_size=(2, 2))(x)
res2=x
#Conv block 3
x=layers.Conv2D(64, 3, strides=1,padding='same', activation=None, name="Conv_5")(x)
x= layers.BatchNormalization()(x)
x= layers.LeakyReLU(alpha=0.3)(x)
x= layers.Conv2D(64, 3, strides=1,padding='same', activation=None, name="Conv_6")(x)
x= layers.BatchNormalization()(x)
x= layers.LeakyReLU(alpha=0.3)(x)
x= layers.MaxPool2D(pool_size=(2, 2))(x)
res3=x

 #latent block
x= layers.Conv2D(128, 3, strides=1, padding='same',activation="relu", name="Conv_7")(x)
x= layers.Dropout(0.5)(x)
x= layers.Conv2D(128, 3, strides=1, padding='same',activation="relu", name="Conv_8")(x)
 
 
 #Deconv block 1
added1 = tf.keras.layers.add([x, res3])
x=layers.Conv2DTranspose(64,5,strides=1,padding='same',activation="relu",name="DeConv_1")(added1)
x= layers.Conv2DTranspose(64,5,strides=2,padding='same',activation="relu",name="DeConv_2")(x)
x= layers.UpSampling2D(size=(2, 2))(x)
 #Deconv block 2
added2 = tf.keras.layers.add([x, res2])
x= layers.Conv2DTranspose(32,5,strides=1,padding='same',activation="relu",name="DeConv_3")(added2)
x= layers.Conv2DTranspose(32,5,strides=2,padding='same',activation="relu",name="DeConv_4")(x)
x= layers.UpSampling2D(size=(2, 2))(x)
 #Deconv block 3
added3 = tf.keras.layers.add([x, res1])
x= layers.Conv2DTranspose(16,5,strides=1,padding='same',activation="relu",name="DeConv_5")(added3)
x= layers.Conv2DTranspose(16,5,strides=2,padding='same',activation="relu",name="DeConv_6")(x)
x= layers.UpSampling2D(size=(2, 2))(x)
outputs= layers.Conv2D(1, 5, strides=1, padding='same',activation="linear",\
           kernel_initializer="Orthogonal",\
           name="Conv_9")(x)

initial_model=tf.keras.Model(inputs=inputs,outputs=outputs)
initial_model.summary()
